# pjt09-slack-monitor-bot
Development of Bot to monitor comments in Slack.

---

## 要件定義・設計

### LLMを使うにあたり、どのように問題を設定したか

- Slackコミュニティの貢献度を定量化し、ランキング・可視化することを目的とした。
- 投稿・リアクション・回答・ポジティブフィードバック・ガイドライン違反など、曖昧なコミュニケーションをLLMを用いて「質的な評価」に自動変換する設計とした。
- 具体的なLLM活用例:
    - 不適切投稿の自動検出（ガイドライン違反検知）
    - 未定義Slackリアクションを「ポジティブ／非ポジティブ」に分類
    - 感謝表現などポジティブフィードバックの自動抽出
    - スレッド返信の「回答」判定

### プロジェクトの成功・失敗定義

- **成功条件**
    - LLMによる自動評価と手動評価の一致率が高い
    - Slack上で「/scoreboard」「/apply_reactions」などのコマンドでユーザーがスコアを確認・管理できる
    - 日次・週次などで正しいランキングやレポートが自動生成される
- **失敗条件**
    - LLM判定が意図から大きくズレている（例：明らかな誤判定）
    - パフォーマンスやコストなど、運用に耐えない場合

### LLMの性能計測

- 既存定義済みポジティブリアクション（例: +1, heart_eyes, raised_handsなど）について、LLMによる自動判定結果と静的定義との一致率を計測
- サンプル質問や感謝メッセージなどの「教師データ」で、ガイドライン違反やポジティブフィードバック判定の精度（正解率・誤検知率）を評価

### プロダクトの性能・非機能要件

- バッチ処理（apply_reactions）や各種コマンドの応答速度
- 日次・週次レポートの自動生成処理の安定稼働
- ログ監査・トレーサビリティの担保
- DBスキーマの拡張性（今後の機能追加や分析のしやすさ）
- LLM APIコール数の最適化・コスト管理

---

## 開発・実装・検証

### 評価データの選定

- Slackコミュニティ実運用の実データを一部マスキングしつつサンプリング
- 想定される典型的な投稿パターン（質問、感謝、冗談、スタンプ多用など）を網羅

### 使用するLLMの選定

- 基本モデルは `gpt-3.5-turbo` と `o4-mini` を比較検証し、APIコスト・応答品質で選択
- 日本語メッセージが多いため、多言語対応モデルや出力安定性も重視

### アプリケーション構築状況

- `app.py` および `utils/` 配下モジュールで、Slackイベント監視・DB記録・LLM API連携をすべて自動化
- 投稿/リアクション/回答/フィードバック/違反の全イベントをDB記録し、集計スクリプトで正確なランキング集計を確認
- コマンドでの手動バッチ判定（apply_reactions）、定期バッチ・自動ランキング生成機能も稼働確認済み

### その他の要件・設計考慮事項

- セルフリアクション・Bot投稿の除外
- DBトランザクション設計
- Slack APIレートリミット対策
- 将来的なNotionやWeb連携を見据えた拡張性重視の設計

---



# pjt09-slack-monitor-bot の紹介

このプロジェクトは、Slackコミュニティ内の発言をリアルタイムに監視・評価し、貢献度ランキングや違反傾向分析を自動生成するBotアプリケーションです。
主な機能:
- **発言イベントの収集**: メッセージ投稿、リアクション、スレッド返信（回答）、ポジティブフィードバック、ガイドライン違反などをSQLiteデータベースに記録
- **LLMによる質的評価**:
  - 不適切投稿（ガイドライン違反）の自動検出とルール番号の記録
  - リアクション絵文字のポジティブ／ネガティブ判定
  - 感謝表現などポジティブフィードバックの自動抽出
  - スレッド返信を「回答」として分類
- **リアルタイムスコア計算**: 投稿数、獲得リアクション数、回答数、ポジティブフィードバック数、違反件数に重量づけした貢献度スコアを算出
- **チャットコマンド**:
  - `/scoreboard [today|weekly|monthly|all]`: 指定期間の上位貢献者ランキングを表示（管理者・一般ユーザー毎に表示範囲を制御）
  - `/apply_reactions`: 未判定リアクションを一括でLLM判定しスコアに反映
- **定期バッチ処理**:
  - APSchedulerを使い、日次・週次・月次・四半期・年次でランキングをNotion DBにアップサート
  - 毎時0分に「本日の累計ランキング」を更新
- **データ可視化**:
  - Notionページ／データベースでのランキング表表示
  - 画像生成スクリプト（matplotlib）による違反傾向（ヒストグラム、時系列、ヒートマップ）の定期生成とNotionページへの自動埋め込み

環境変数（`.env` に設定）:
```dotenv
SLACK_BOT_TOKEN= xoxb-...             # Slack Bot Token
SLACK_APP_TOKEN= xapp-...             # Slack App Level Token（Socket Mode用）
ADMIN_CHANNEL= C0123456789            # 管理者向け通知チャンネルID
QUESTION_CHANNEL= C0987654321         # 質問用通知チャンネルID
BOT_DEV_CHANNEL= C1234567890          # ボット投稿用チャンネルID（通常投稿用）
SCORES_DB_PATH= ./scores.db          # SQLite データベースファイルパス
TOP_N= 5                            # ランキングで表示する上位ユーザー数（デフォルト5）
NOTION_TOKEN= secret                 # Notion API統合トークン
NOTION_PAGE_ID= 21408ac90f4...       # ランキング用NotionページID
NOTION_DB_ID= 21408ac90f4...         # データベース用Notion DB ID
NOTION_UPDATED_BLOCK_ID= ...          # 最終更新日時表示用ブロックID
NOTION_VIOLATION_DB_ID= ...           # 違反傾向分析用Notion DB ID（必要な場合）
```

